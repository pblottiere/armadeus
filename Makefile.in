#
# Defines all important paths to ease sub-systems compilation.
# !! Don't forget to define ARMADEUS_BASE_DIR relatively to your
# calling directory before including this file !!
#

ifeq ($(ARMADEUS_BASE_DIR),)
ARMADEUS_BASE_DIR:=$(shell pwd)
endif

BUILDROOT_DIR = $(ARMADEUS_BASE_DIR)/buildroot
BASE_DIR = $(BUILDROOT_DIR)/output

ifneq ($(BUILDROOT_DL_DIR),)
# To be removed with BR 2014.02
ARMADEUS_DL_DIR := $(BUILDROOT_DL_DIR)
else
 ifneq ($(BR2_DL_DIR),)
 ARMADEUS_DL_DIR := $(BR2_DL_DIR)
 else
 ARMADEUS_DL_DIR := $(shell grep "BR2_DL_DIR=" $(BUILDROOT_DIR)/.config 2>/dev/null | cut -d \" -f 2 | sed 's;$$(BASE_DIR);$(BASE_DIR);')
 endif
endif

-include $(BUILDROOT_DIR)/.config
# avoid to lost env variable because .config contains BR2_DL_DIR
BR2_DL_DIR = $(ARMADEUS_DL_DIR)

ARMADEUS_LINUX_VERSION:=$(shell echo $(BR2_LINUX_KERNEL_VERSION))
ARMADEUS_LINUX_MAIN_VERSION:=$(shell echo $(ARMADEUS_LINUX_VERSION) | cut -d . -f 1-3)
ARMADEUS_U_BOOT_VERSION:=$(shell echo $(BR2_TARGET_UBOOT_VERSION))
ARMADEUS_U_BOOT_CUSTOM_VERSION = $(shell echo $(BR2_TARGET_UBOOT_CUSTOM_PATCH_DIR) | awk '{ print substr( $$0, length($$0) - 6, 7 ) }')
ARMADEUS_LIBC_NAME=unknown
ARMADEUS_LIBC_VERSION=X.Y
ifeq ($(BR2_TOOLCHAIN_BUILDROOT),y)
ARMADEUS_LIBC_NAME=uClibc
ARMADEUS_LIBC_VERSION:=$(shell echo $(BR2_UCLIBC_VERSION_STRING))
endif
ifeq ($(BR2_TOOLCHAIN_CTNG),y)
ARMADEUS_LIBC_NAME:=$(BR2_TOOLCHAIN_CTNG_LIBC)
ARMADEUS_LIBC_VERSION:=$(shell grep CT_LIBC_VERSION $(BUILDROOT_DIR)/$(BR2_TOOLCHAIN_CTNG_CONFIG) | cut -d = -f 2)
endif
ifeq ($(BR2_TOOLCHAIN_EXTERNAL),y)
ARMADEUS_LIBC_NAME=glibc
endif

ifneq ($(BR2_BUSYBOX_VERSION),)
# pre 2014.11 BR
ARMADEUS_BUSYBOX_VERSION:=$(shell echo $(BR2_BUSYBOX_VERSION))
else
# post 2014.11 BR
ARMADEUS_BUSYBOX_VERSION:=$(shell egrep "BUSYBOX_VERSION =" $(BUILDROOT_DIR)/package/busybox/busybox.mk 2>/dev/null | cut -d ' ' -f 3)
endif

ARMADEUS_BOARD_NAME:=$(shell echo $(BR2_BOARD_NAME))
ARMADEUS_U_BOOT_BOARD_NAME:=$(shell echo $(BR2_TARGET_UBOOT_BOARDNAME))
ARMADEUS_TARGET_ARCH:=$(shell echo $(BR2_GCC_TARGET_ARCH))

ifeq ($(BR2_PACKAGE_QT),y)
ARMADEUS_QT_MAKEFILE:=package/qt/qt.mk
ARMADEUS_QT_VERSION_MAJOR:=$(shell grep "QT_VERSION_MAJOR =" $(BUILDROOT_DIR)/$(ARMADEUS_QT_MAKEFILE) 2>/dev/null | cut -d ' ' -f 3)
ARMADEUS_QT_VERSION:=$(ARMADEUS_QT_VERSION_MAJOR)"."$(shell grep "QT_VERSION =" $(BUILDROOT_DIR)/$(ARMADEUS_QT_MAKEFILE) 2>/dev/null | cut -d '.' -f 2)
ARMADEUS_QT_VERSION:=$(strip $(ARMADEUS_QT_VERSION))
else
ARMADEUS_QT_VERSION:=QT_NOT_INSTALLED
endif

ARMADEUS_PATCH_DIR=$(ARMADEUS_BASE_DIR)/patches
BUILDROOT_OUTPUT_DIR:=$(BUILDROOT_DIR)/output
BUILDROOT_PROJECT_BUILD_DIR:=$(BUILDROOT_OUTPUT_DIR)/build
BUILDROOT_TOOLCHAIN_BUILD_DIR:=$(BUILDROOT_OUTPUT_DIR)/toolchain
BUILDROOT_BUILD_DIR:=$(BUILDROOT_OUTPUT_DIR)/build
ifneq ($(BR2_HOST_DIR),)
BUILDROOT_HOST_DIR:=$(shell echo $(BR2_HOST_DIR))
else
BUILDROOT_HOST_DIR:=$(BUILDROOT_DIR)/output/host
endif
ARMADEUS_BINARIES:=$(BUILDROOT_OUTPUT_DIR)/images
ARMADEUS_ROOTFS_DIR:=$(BUILDROOT_OUTPUT_DIR)/target
ARMADEUS_ROOTFS_TAR:=$(ARMADEUS_BINARIES)/$(ARMADEUS_BOARD_NAME)-rootfs.tar

ARMADEUS_LINUX_DIR:=$(BUILDROOT_PROJECT_BUILD_DIR)/linux-$(ARMADEUS_LINUX_VERSION)
ifneq ($(BR2_LINUX_KERNEL_PATCH),)
ARMADEUS_LINUX_PATCH_DIR:=$(BUILDROOT_DIR)/$(BR2_LINUX_KERNEL_PATCH)
else
ARMADEUS_LINUX_PATCH_DIR:=$(ARMADEUS_PATCH_DIR)/linux/$(ARMADEUS_LINUX_VERSION)
endif
ARMADEUS_U_BOOT_DIR:=$(BUILDROOT_PROJECT_BUILD_DIR)/uboot-$(ARMADEUS_U_BOOT_VERSION)
ARMADEUS_UCLIBC_DIR:=$(BUILDROOT_TOOLCHAIN_BUILD_DIR)/uClibc-$(ARMADEUS_UCLIBC_VERSION)
ARMADEUS_BOARD_DIR:=$(BUILDROOT_DIR)/target/device/armadeus/$(ARMADEUS_BOARD_NAME)
ARMADEUS_LINUX_CONFIG:=$(ARMADEUS_BOARD_DIR)/$(ARMADEUS_BOARD_NAME)-linux-$(ARMADEUS_LINUX_MAIN_VERSION).config
ARMADEUS_U_BOOT_CONFIG:=$(BUILDROOT_DIR)/$(shell echo $(BR2_TARGET_UBOOT_CUSTOM_CONFIG_FILE))
ARMADEUS_STAGING_DIR:=$(BUILDROOT_OUTPUT_DIR)/staging
ARMADEUS_TOOLCHAIN_PATH:=$(BUILDROOT_HOST_DIR)/usr/bin
ifeq ($(BR2_TOOLCHAIN_EXTERNAL),y)
ARMADEUS_TOOLCHAIN_PREFIX=$(BR2_TOOLCHAIN_EXTERNAL_PREFIX)-
else
ARMADEUS_TOOLCHAIN_PREFIX=arm-linux-
endif
ARMADEUS_GCC_VERSION=$(shell $(ARMADEUS_TOOLCHAIN_PATH)/$(ARMADEUS_TOOLCHAIN_PREFIX)gcc -dumpversion)

ARMADEUS_BUILD_DIR:=$(BUILDROOT_BUILD_DIR)
ARMADEUS_QT_DIR:=$(ARMADEUS_BUILD_DIR)/qt-$(ARMADEUS_QT_VERSION)
